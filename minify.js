'use strict';const IMS_TOKEN_URL='https://ims-na1.adobelogin.com/ims/token/v3',IMS_SCOPE='openid,AdobeID,additional_info.roles,profile,commerce.accs.org.read,additional_info.projectedProductContext,email',ACCESS_TOKEN_STATE_KEY='ims:accessToken';async function cacheToken(e,t,n){if(!e||!t)return;const o=Number(n);await e.put(ACCESS_TOKEN_STATE_KEY,t,o)}async function getCachedToken(e){if(!e)return null;try{return await e.get(ACCESS_TOKEN_STATE_KEY)}catch{return null}}async function requestImsToken(e,t){const n=e?.secrets||{},o=n.IMS_CLIENT_ID,r=n.IMS_CLIENT_SECRET;if(!o||!r)throw new Error('IMS client credentials are missing');const s=new URLSearchParams;s.set('client_secret',r),s.set('grant_type','client_credentials'),s.set('scope',IMS_SCOPE);const a=`${IMS_TOKEN_URL}?client_id=${encodeURIComponent(o)}`,c=await fetch(a,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:s});let i;try{i=await c.json()}catch{throw new Error('IMS token endpoint returned invalid JSON')}if(!c.ok)throw new Error(i?.error_description||i?.error||c.statusText||'IMS token request failed');return{accessToken:i.access_token,expiresIn:i.expires_in}}async function ensureImsToken(e,t){const{state:n}=e||{},o=await getCachedToken(n);if(o)return o;const{accessToken:r,expiresIn:s}=await requestImsToken(e,t);return await cacheToken(n,r,s),r}module.exports.injectImsAuth=async({context:e,sourceName:t})=>{if(!e)return{status:'ERROR',message:'Hook context is unavailable'};const{logger:n}=e;try{const t=await ensureImsToken(e,n);return n?.info?.(`Token is ${t}`),{status:'SUCCESS',message:'Authorized',data:{request:{headers:{Authorization:`Bearer ${t}`}}}}}catch(e){return n?.error?.(`IMS auth hook failed: ${e.message}`),{status:'ERROR',message:`Unable to obtain IMS token: ${e.message}`}}};